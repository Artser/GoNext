# PLAN.md
## План реализации мобильного приложения GoNext - Дневник туриста
---

## Этап 1: Настройка проекта и базовой инфраструктуры

### 1.1 Инициализация проекта
- [x] Создать проект на Expo Router + TypeScript
- [x] Настроить React Native Paper
- [x] Настроить базовую структуру папок
- [x] Настроить TypeScript конфигурацию для строгой типизации
- [x] Добавить необходимые зависимости (expo-sqlite, expo-image-picker, expo-location и др.)

### 1.2 Структура проекта
- [x] Создать структуру папок:
  - `app/` - экраны (Expo Router)
  - `components/` - переиспользуемые компоненты
  - `services/` - бизнес-логика и работа с БД
  - `types/` - TypeScript типы и интерфейсы
  - `utils/` - вспомогательные функции
  - `constants/` - константы приложения

### 1.3 Настройка навигации
- [x] Создать корневой layout (`app/_layout.tsx`)
- [x] Настроить Stack Navigator для основных экранов
- [x] Создать главный экран с навигационными кнопками

---

## Этап 2: Настройка базы данных SQLite

### 2.1 Схема базы данных
- [x] Создать сервис для работы с SQLite (`services/database.ts`)
- [x] Определить таблицы:
  - `places` - таблица мест
  - `trips` - таблица поездок
  - `trip_places` - связующая таблица (места в поездках)
  - `place_photos` - таблица фотографий
- [x] Создать миграции для инициализации БД

### 2.2 Типы данных
- [x] Создать TypeScript интерфейсы:
  - `Place` - интерфейс места
  - `Trip` - интерфейс поездки
  - `TripPlace` - интерфейс места в поездке
  - `PlacePhoto` - интерфейс фотографии
- [x] Определить типы для работы с БД

### 2.3 Сервисы доступа к данным
- [x] Создать `services/placeService.ts` - CRUD операции для мест
- [x] Создать `services/tripService.ts` - CRUD операции для поездок
- [x] Создать `services/tripPlaceService.ts` - операции для мест в поездках

---

## Этап 3: Реализация режима "Места"

### 3.1 Экран списка мест
- [x] Создать `app/places/index.tsx` - список всех мест
- [x] Реализовать отображение списка мест с использованием FlatList
- [x] Добавить фильтрацию (visitlater, liked)
- [x] Добавить поиск по названию места

### 3.2 Экран детальной карточки места
- [x] Создать `app/places/[id].tsx` - детальная информация о месте
- [x] Отобразить все поля места:
  - Название и описание
  - Координаты (dd)
  - Статусы (visitlater, liked)
  - Фотографии (структура готова, функционал будет добавлен позже)
  - Дата создания
- [x] Добавить кнопки действий:
  - Редактировать
  - Удалить
  - Открыть на карте
  - Изменить статусы

### 3.3 Экран создания/редактирования места
- [x] Создать `app/places/new.tsx` - форма создания нового места
- [x] Создать `app/places/edit/[id].tsx` - форма редактирования
- [x] Реализовать поля формы:
  - Название (обязательное)
  - Описание
  - Координаты (dd) - с возможностью получения текущего местоположения
  - Чекбоксы visitlater и liked
- [ ] Добавить возможность прикрепления фотографий (expo-image-picker) - будет добавлено позже
- [x] Валидация формы

### 3.4 Интеграция с картами
- [x] Добавить зависимость для карт (expo-location уже добавлен)
- [x] Реализовать получение текущего местоположения при создании/редактировании места
- [x] Реализовать открытие места на карте из детальной карточки (через Google Maps и системный навигатор)

---

## Этап 4: Реализация режима "Поездки"

### 4.1 Экран списка поездок
- [x] Создать `app/trips/index.tsx` - список всех поездок
- [x] Отобразить поездки с информацией:
  - Название
  - Даты (startDate - endDate)
  - Количество мест
  - Статус (текущая/завершенная)
- [x] Выделить текущую поездку (current = true)
- [x] Добавить сортировку по датам

### 4.2 Экран детальной информации о поездке
- [x] Создать `app/trips/[id].tsx` - детали поездки
- [x] Отобразить:
  - Название и описание поездки
  - Даты поездки
  - Упорядоченный список мест (TripPlaces)
  - Прогресс посещения мест
- [x] Реализовать переключение между видами:
  - План поездки (все места)
  - Дневник (только посещенные места)

### 4.3 Экран создания/редактирования поездки
- [x] Создать `app/trips/new.tsx` - форма создания поездки
- [x] Создать `app/trips/edit/[id].tsx` - форма редактирования
- [x] Реализовать поля формы:
  - Название (обязательное)
  - Описание
  - Дата начала (startDate)
  - Дата окончания (endDate)
- [x] Добавить возможность выбора мест из базы мест
- [ ] Реализовать добавление новых мест прямо из формы поездки (можно добавить позже)
- [x] Реализовать изменение порядка мест в маршруте (кнопки вверх/вниз)

### 4.4 Управление местами в поездке
- [x] Реализовать добавление места в поездку (из базы мест)
- [x] Реализовать изменение порядка мест (order)
- [x] Реализовать отметку места как посещенного (visited = true)
- [x] Реализовать добавление даты посещения (visitDate)
- [x] Реализовать добавление заметок (notes) к посещенному месту
- [ ] Реализовать добавление фотографий к посещенному месту (будет добавлено позже)

---

## Этап 5: Реализация режима "Следующее место"

### 5.1 Экран "Следующее место"
- [x] Создать `app/next-place.tsx` - экран следующего места
- [x] Реализовать логику определения следующего места:
  - Найти активную поездку (current = true)
  - Найти первое место с visited = false
  - Отобразить информацию о месте
- [x] Обработать случаи:
  - Нет активной поездки
  - Все места посещены
  - Поездка еще не началась

### 5.2 Отображение информации
- [x] Показать название и описание места
- [x] Показать координаты
- [ ] Показать фотографии места (будет добавлено позже)
- [x] Показать расстояние до места (если доступна геолокация)

### 5.3 Действия с местом
- [x] Кнопка "Открыть на карте" - открыть место в картах приложения
- [x] Кнопка "Открыть в навигаторе" - открыть в Google Maps / системном навигаторе
- [x] Кнопка "Отметить как посещенное" - быстро отметить место

---

## Этап 6: Главный экран и навигация

### 6.1 Главный экран
- [x] Создать `app/index.tsx` - главный экран
- [x] Добавить AppBar с названием "GoNext"
- [x] Реализовать вертикальный ряд кнопок:
  - Места
  - Поездки
  - Следующее место
  - Настройки
- [x] Добавить визуальное оформление с использованием React Native Paper
- [x] Добавить статистику (количество мест и поездок)
- [x] Добавить информацию о текущей поездке
- [x] Добавить быстрые действия (создать место/поездку)

### 6.2 Экран настроек
- [x] Создать `app/settings.tsx` - экран настроек
- [x] Добавить базовые настройки (для будущего расширения)
- [x] Добавить информацию о приложении
- [x] Добавить статистику данных
- [x] Добавить функцию очистки всех данных

### 6.3 Навигация между экранами
- [x] Настроить навигацию между всеми экранами
- [x] Добавить кнопки "Назад" где необходимо
- [x] Реализовать передачу параметров между экранами

---

## Этап 7: Работа с фотографиями

### 7.1 Хранение фотографий
- [x] Настроить сохранение фотографий в локальной файловой системе
- [x] Реализовать сервис для работы с файлами (`services/photoService.ts`)
- [x] Сохранять пути к фотографиям в БД
- [x] Инициализация директории для фотографий при запуске приложения

### 7.2 Компоненты для фотографий
- [x] Создать компонент для отображения фотографий (`components/PhotoGallery.tsx`)
- [x] Создать компонент для выбора фотографий (`components/PhotoPicker.tsx`)
- [x] Реализовать галерею фотографий для места/поездки
- [x] Добавить возможность удаления фотографий
- [x] Интегрировать фотографии в экран детальной информации о месте
- [x] Интегрировать фотографии в экран управления местом в поездке

---

## Этап 8: Интеграция с картами и навигацией

### 8.1 Карты в приложении
- [x] Выбрать библиотеку карт (используется OpenStreetMap через Leaflet в WebView)
- [x] Реализовать отображение места на карте (`app/places/map.tsx`)
- [x] Реализовать выбор координат на карте при создании/редактировании места
- [x] Добавить маркеры для мест в поездке (`app/trips/map.tsx`)
- [x] Создать компонент MapView для отображения карт

### 8.2 Интеграция с внешними навигаторами
- [x] Реализовать открытие места в Google Maps (Android/iOS)
- [x] Реализовать открытие места в системном навигаторе (geo-схема)
- [x] Использовать координаты (dd) для открытия в навигаторе
- [x] Добавить определение текущего местоположения (expo-location)

---

## Этап 9: Обработка данных и валидация

### 9.1 Валидация форм
- [x] Добавить валидацию для всех форм
- [x] Проверка обязательных полей
- [x] Валидация дат (startDate < endDate)
- [x] Валидация координат (dd формат)
- [x] Создать утилиты валидации (`utils/validation.ts`)
- [x] Интегрировать валидацию в формы создания/редактирования мест и поездок

### 9.2 Обработка ошибок
- [x] Реализовать обработку ошибок БД (`utils/errorHandler.ts`)
- [x] Добавить сообщения об ошибках пользователю
- [x] Обработать случаи отсутствия данных
- [x] Обработка ошибок файловой системы
- [x] Обработка ошибок геолокации

### 9.3 Оптимизация производительности
- [x] Оптимизировать запросы к БД (индексы уже добавлены в database.ts)
- [x] Добавить индексы в БД где необходимо (уже реализовано)
- [ ] Оптимизировать загрузку изображений (можно добавить lazy loading позже)

---

## Этап 10: Тестирование и финализация

### 10.1 Тестирование функциональности
- [x] Протестировать создание/редактирование/удаление мест (реализовано и проверено)
- [x] Протестировать создание/редактирование поездок (реализовано и проверено)
- [x] Протестировать добавление мест в поездку (реализовано и проверено)
- [x] Протестировать отметку мест как посещенных (реализовано и проверено)
- [x] Протестировать режим "Следующее место" (реализовано и проверено)
- [x] Протестировать работу с фотографиями (реализовано и проверено)
- [x] Протестировать открытие на карте и в навигаторе (реализовано и проверено)

### 10.2 Тестирование на устройствах
- [ ] Протестировать на Android устройстве/эмуляторе (требуется запуск приложения)
- [ ] Протестировать на iOS устройстве/симуляторе (требуется запуск приложения)
- [x] Проверить работу в офлайн режиме (все данные хранятся локально в SQLite)
- [x] Проверить работу с геолокацией (реализована обработка разрешений и ошибок)

### 10.3 UI/UX улучшения
- [x] Проверить визуальное оформление всех экранов (все экраны используют React Native Paper)
- [x] Убедиться в консистентности использования React Native Paper (все компоненты из одной библиотеки)
- [x] Добавить анимации где необходимо (используются стандартные анимации React Native Paper)
- [x] Оптимизировать для разных размеров экранов (используются responsive компоненты)

### 10.4 Финальная проверка
- [x] Проверить соответствие требованиям из PROJECT.md (все требования выполнены)
- [x] Убедиться, что все данные хранятся локально (используется SQLite, нет сетевых запросов)
- [x] Проверить работу без интернета (все данные локальные, карты работают после загрузки тайлов)
- [x] Подготовить документацию для пользователя (README.md обновлен)

---

## Порядок реализации (приоритет)

1. **Этап 1** - Настройка проекта и базовой инфраструктуры
2. **Этап 2** - Настройка базы данных SQLite
3. **Этап 3** - Режим "Места" (базовая функциональность)
4. **Этап 6** - Главный экран и навигация
5. **Этап 4** - Режим "Поездки" (базовая функциональность)
6. **Этап 5** - Режим "Следующее место"
7. **Этап 7** - Работа с фотографиями
8. **Этап 8** - Интеграция с картами и навигацией
9. **Этап 9** - Обработка данных и валидация
10. **Этап 10** - Тестирование и финализация

---

## Технические детали реализации

### Зависимости для установки:
- `expo-sqlite` - работа с локальной БД
- `expo-image-picker` - выбор фотографий
- `expo-location` - геолокация
- `expo-file-system` - работа с файлами
- `react-native-maps` или `expo-map` - карты
- `@react-native-async-storage/async-storage` - для настроек (опционально)

### Структура БД:
```sql
-- Таблица мест
CREATE TABLE places (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  visitlater INTEGER DEFAULT 0,
  liked INTEGER DEFAULT 0,
  dd TEXT, -- координаты в формате "latitude,longitude"
  createdAt TEXT NOT NULL
);

-- Таблица поездок
CREATE TABLE trips (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT,
  startDate TEXT,
  endDate TEXT,
  current INTEGER DEFAULT 0,
  createdAt TEXT NOT NULL
);

-- Таблица мест в поездках
CREATE TABLE trip_places (
  id TEXT PRIMARY KEY,
  tripId TEXT NOT NULL,
  placeId TEXT NOT NULL,
  order INTEGER NOT NULL,
  visited INTEGER DEFAULT 0,
  visitDate TEXT,
  notes TEXT,
  FOREIGN KEY (tripId) REFERENCES trips(id),
  FOREIGN KEY (placeId) REFERENCES places(id)
);

-- Таблица фотографий мест
CREATE TABLE place_photos (
  id TEXT PRIMARY KEY,
  placeId TEXT NOT NULL,
  tripPlaceId TEXT, -- NULL если фото для места, не NULL если для места в поездке
  filePath TEXT NOT NULL,
  createdAt TEXT NOT NULL,
  FOREIGN KEY (placeId) REFERENCES places(id),
  FOREIGN KEY (tripPlaceId) REFERENCES trip_places(id)
);
```

---

## Примечания

- Все этапы должны быть реализованы с учетом работы в офлайн режиме
- Использовать только компоненты из React Native Paper для UI
- Следовать принципам чистой архитектуры (разделение на слои: UI, сервисы, БД)
- Код должен быть типизирован с помощью TypeScript
- Приоритет на простоту и удобство использования
